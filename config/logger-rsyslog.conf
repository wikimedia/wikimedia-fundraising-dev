# Other containers send logs here to UDP port 9514
module( load="imudp" )
input( type="imudp" port="9514" )

# Uncomment the following lines and restart the logger container to debug this config
#$DebugFile /logs/rsyslog.debug
#$DebugLevel 2

# Xdebug sends really big messages, so raise the limit
# TODO Add this to rsyslog.conf created inside other containers, too
$MaxMessageSize 64k

$template ApacheAccess, "/logs/%$!service%-apache-access.log"
$template ApacheError, "/logs/%$!service%-apache-error.log"
$template MediaWiki, "/logs/%$!service%-mediawiki.log"
$template Xdebug, "/logs/%$!service%-xdebug.log"
$template Syslog, "/logs/%$!service%-syslog"

# All messages generated by rsyslogd itself will go to a single file, with the service
# name inserted at the beginning of the log message.
$template Rsyslog, "/logs/rsyslog"
$template RsyslogMsg, "%TIMESTAMP% %HOSTNAME% %$!service% %syslogtag%%msg:::drop-last-lf%\n"

if ( $fromhost contains 'payments' ) then {
	set $!service='payments';

} else if ( $fromhost contains 'email-pref-ctr') then {
	set $!service='email-pref-ctr';

} else if ( $fromhost contains 'civicrm') then {
	set $!service='civicrm';

} else if ( $fromhost contains 'smashpig') then {
	set $!service='smashpig';

} else if ( $fromhost contains 'civiproxy') then {
	set $!service='civiproxy';

} else if ( $fromhost contains 'privatebin') then {
	set $!service='privatebin';

} else {
	set $!service='nomatch';
}

# apache sends logs syslog, set via apache config
if ( $syslogtag contains 'httpd' ) then {
	*.=notice ?ApacheAccess
	*.err ?ApacheError

# mediawiki debug logs also sent to syslog
} else if ( $syslogtag contains 'mediawiki' ) then {
	*.* ?MediaWiki

# local rsyslog process in container re-sends logs written to /tmp/xdebug.log
} else if ( $syslogtag contains 'xdebug' ) then {
	*.* ?Xdebug

# separate out messages generated by rsyslogd itself
} else if ( $syslogtag contains 'rsyslogd' ) then {
	*.* ?Rsyslog;RsyslogMsg

} else {
	# anything not from httpd or xdebug is what would be sent to syslog on production
	*.* ?Syslog
}
